"use strict";(self.webpackChunkiota_wiki=self.webpackChunkiota_wiki||[]).push([[84101],{3905:(e,t,n)=>{n.d(t,{Zo:()=>d,kt:()=>h});var r=n(67294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,r,o=function(e,t){if(null==e)return{};var n,r,o={},a=Object.keys(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var l=r.createContext({}),c=function(e){var t=r.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},d=function(e){var t=c(e.components);return r.createElement(l.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},u=r.forwardRef((function(e,t){var n=e.components,o=e.mdxType,a=e.originalType,l=e.parentName,d=i(e,["components","mdxType","originalType","parentName"]),u=c(n),h=o,g=u["".concat(l,".").concat(h)]||u[h]||p[h]||a;return n?r.createElement(g,s(s({ref:t},d),{},{components:n})):r.createElement(g,s({ref:t},d))}));function h(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var a=n.length,s=new Array(a);s[0]=u;var i={};for(var l in t)hasOwnProperty.call(t,l)&&(i[l]=t[l]);i.originalType=e,i.mdxType="string"==typeof e?e:o,s[1]=i;for(var c=2;c<a;c++)s[c]=n[c];return r.createElement.apply(null,s)}return r.createElement.apply(null,n)}u.displayName="MDXCreateElement"},74773:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>s,default:()=>p,frontMatter:()=>a,metadata:()=>i,toc:()=>c});var r=n(87462),o=(n(67294),n(3905));const a={description:"Invoking smart contracts with on-ledger and off-ledger requests with Solo.",image:"/img/tutorial/send_request.png",keywords:["how-to","explanation","testing","PostRequestSync","PostRequestOffLedger","send","requests","post","solo","on-ledger","off-ledger"]},s="Invoking Smart Contracts",i={unversionedId:"guide/solo/invoking-sc",id:"guide/solo/invoking-sc",title:"Invoking Smart Contracts",description:"Invoking smart contracts with on-ledger and off-ledger requests with Solo.",source:"@site/next/external/wasp/documentation/docs/guide/solo/invoking-sc.md",sourceDirName:"guide/solo",slug:"/guide/solo/invoking-sc",permalink:"/next/smart-contracts/guide/solo/invoking-sc",draft:!1,editUrl:"https://github.com/iotaledger/wasp/edit/develop/documentation/next/external/wasp/documentation/docs/guide/solo/invoking-sc.md",tags:[],version:"current",frontMatter:{description:"Invoking smart contracts with on-ledger and off-ledger requests with Solo.",image:"/img/tutorial/send_request.png",keywords:["how-to","explanation","testing","PostRequestSync","PostRequestOffLedger","send","requests","post","solo","on-ledger","off-ledger"]},sidebar:"tutorialSidebar",previous:{title:"Deploying Wasm Smart Contracts",permalink:"/next/smart-contracts/guide/solo/deploying-sc"},next:{title:"Calling a View",permalink:"/next/smart-contracts/guide/solo/view-sc"}},l={},c=[{value:"Parameters",id:"parameters",level:2},{value:"<code>NewCallParams()</code>",id:"newcallparams",level:3},{value:"<code>WithMaxAffordableGasBudget()</code>",id:"withmaxaffordablegasbudget",level:3},{value:"<code>PostRequestSync()</code>",id:"postrequestsync",level:2},{value:"On-Ledger Requests",id:"on-ledger-requests",level:2},{value:"Off-ledger Requests",id:"off-ledger-requests",level:2}],d={toc:c};function p(e){let{components:t,...a}=e;return(0,o.kt)("wrapper",(0,r.Z)({},d,a,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"invoking-smart-contracts"},"Invoking Smart Contracts"),(0,o.kt)("p",null,"After deploying\nthe ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/iotaledger/wasp/tree/develop/documentation/tutorial-examples/src/solotutorial.rs"},(0,o.kt)("inlineCode",{parentName:"a"},"solotutorial")),"\nsmart contract, you can invoke the ",(0,o.kt)("inlineCode",{parentName:"p"},"storeString")," function:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-go"},'func TestTutorialInvokeSC(t *testing.T) {\n    env := solo.New(t, &solo.InitOptions{AutoAdjustStorageDeposit: true})\n    chain := env.NewChain()\n    err := chain.DeployWasmContract(nil, "solotutorial", "solotutorial_bg.wasm")\n    require.NoError(t, err)\n\n    // invoke the `storeString` function\n    req := solo.NewCallParams("solotutorial", "storeString", "str", "Hello, world!").\n        WithMaxAffordableGasBudget()\n    _, err = chain.PostRequestSync(req, nil)\n    require.NoError(t, err)\n\n    // invoke the `getString` view\n    res, err := chain.CallView("solotutorial", "getString")\n    require.NoError(t, err)\n    require.Equal(t, "Hello, world!", codec.MustDecodeString(res.MustGet("str")))\n}\n')),(0,o.kt)("h2",{id:"parameters"},"Parameters"),(0,o.kt)("h3",{id:"newcallparams"},(0,o.kt)("inlineCode",{parentName:"h3"},"NewCallParams()")),(0,o.kt)("p",null,"The above example uses ",(0,o.kt)("inlineCode",{parentName:"p"},"NewCallParams")," to set up the parameters of the request that it will send to the contract.\nIt specifies that it wants to invoke the ",(0,o.kt)("inlineCode",{parentName:"p"},"storeString")," entry point of the ",(0,o.kt)("inlineCode",{parentName:"p"},"solotutorial")," smart contract, passing the\nparameter named ",(0,o.kt)("inlineCode",{parentName:"p"},"str")," with the string value ",(0,o.kt)("inlineCode",{parentName:"p"},'"Hello, world!"'),"."),(0,o.kt)("h3",{id:"withmaxaffordablegasbudget"},(0,o.kt)("inlineCode",{parentName:"h3"},"WithMaxAffordableGasBudget()")),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"WithMaxAffordableGasBudget()")," assigns the gas budget of the request to the maximum that the sender can afford with the\nfunds they own on L2 (including any funds attached in the request itself).\nIn this case the funds attached automatically for the storage deposit will be enough to cover for the gas fee, so it is\nnot necessary to manually deposit more funds for gas."),(0,o.kt)("h2",{id:"postrequestsync"},(0,o.kt)("inlineCode",{parentName:"h2"},"PostRequestSync()")),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"PostRequestSync")," sends an on-ledger request to the chain."),(0,o.kt)("h2",{id:"on-ledger-requests"},"On-Ledger Requests"),(0,o.kt)("p",null,(0,o.kt)("a",{target:"_blank",href:n(57861).Z},(0,o.kt)("img",{alt:"Generic process of posting an on-ledger request to the smart contract",src:n(61736).Z,width:"862",height:"452"}))),(0,o.kt)("p",null,"The diagram above depicts the generic process of posting an ",(0,o.kt)("em",{parentName:"p"},"on-ledger")," request to the smart contract.\nThe same diagram is valid for the Solo environment and any other requester that sends an on-ledger request, e.g., the\nIOTA Smart Contracts wallet or another chain."),(0,o.kt)("p",null,"Posting an on-ledger request always consists of the steps below.\nNote that in Solo, all seven steps are carried out by a single call to ",(0,o.kt)("inlineCode",{parentName:"p"},"PostRequestSync"),"."),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Create the L1 transaction, which wraps the L2 request and moves tokens."),(0,o.kt)("p",{parentName:"li"},"Each on-ledger request must be contained in a transaction on the ledger.\nTherefore, it must be signed by the sender\u2019s private key.\nThis securely identifies each requester in IOTA Smart Contracts.\nIn Solo, the transaction is signed by the private key provided in the second parameter of the ",(0,o.kt)("inlineCode",{parentName:"p"},"PostRequestSync")," call\n(",(0,o.kt)("inlineCode",{parentName:"p"},"chain.OriginatorPrivateKey()")," by default).")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Post and confirm the transaction to the L1 ledger."),(0,o.kt)("p",{parentName:"li"},"In Solo, it is just adding the transaction to the emulated L1 ledger, so it is confirmed immediately and\nsynchronously.\nThe confirmed transaction on the ledger becomes part of the backlog of requests to be processed by the chain.\nIn the real L1 ledger, the sender must wait until the ledger confirms the transaction.")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"The chain picks the request from the backlog and runs the request on the VM.")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"The VM calls the target entry point of the smart contract program. The program updates the state.")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"The VM produces a state update transaction (the ",(0,o.kt)("em",{parentName:"p"},"anchor"),").")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"The chain signs the transaction with its private key (the ",(0,o.kt)("inlineCode",{parentName:"p"},"chain.StateControllerKeyPair()")," in Solo).")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"The chain posts the resulting transaction to the L1 ledger and, after confirmation, commits the corresponding state."))),(0,o.kt)("p",null,"The following lines in the test log correspond to step 7:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-log"},"49:37.771863573 INFO    TestTutorialInvokeSC    solo/solo.go:171        solo publisher: state [tgl1pzehtgythywhnhnz26s2vtpe2wy4y64pfcwkp9qvzhpwghzxhwkps2tk0nd 4 1 0-177c8a62feb7d434608215a179dd6637b8038d1237dd264\nd8feaf4d9a851b808 0000000000000000000000000000000000000000000000000000000000000000]\n49:37.771878833 INFO    TestTutorialInvokeSC    solo/solo.go:171        solo publisher: request_out [tgl1pzehtgythywhnhnz26s2vtpe2wy4y64pfcwkp9qvzhpwghzxhwkps2tk0nd 0-c55b41b07687c644b7f7a1b9fb5da86f2d40195f39885\nbc348767e2dd285ca15 4 1]\n49:37.771884127 INFO    TestTutorialInvokeSC.ch1        solo/run.go:156 state transition --\x3e #4. Requests in the block: 1. Outputs: 1\n")),(0,o.kt)("h2",{id:"off-ledger-requests"},"Off-ledger Requests"),(0,o.kt)("p",null,"Alternatively, you could send an off-ledger request by using ",(0,o.kt)("inlineCode",{parentName:"p"},"chain.PostRequestOffLedger")," instead of ",(0,o.kt)("inlineCode",{parentName:"p"},"PostRequestSync"),".\nHowever, since off-ledger requests cannot have tokens attached, in order to cover the gas fee, you must deposit funds to\nthe chain beforehand:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-go"},"user, _ := env.NewKeyPairWithFunds(env.NewSeedFromIndex(1))\nchain.DepositBaseTokensToL2(10_000, user) // to cover gas fees\n_, err = chain.PostRequestOffLedger(req, user)\nrequire.NoError(t, err)\n")))}p.isMDXComponent=!0},57861:(e,t,n)=>{n.d(t,{Z:()=>r});const r=n.p+"assets/files/send_request-78a4959e80ea79872674de5ba5faaa86.png"},61736:(e,t,n)=>{n.d(t,{Z:()=>r});const r=n.p+"assets/images/send_request-78a4959e80ea79872674de5ba5faaa86.png"}}]);